<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Add Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
  <!-- Flatpickr for date picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body style="background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%); min-height: 100vh; font-family: 'Roboto', sans-serif;">
  <div class="container py-3 py-md-4">
    <!-- Header Card -->
    <div class="card mb-4 shadow-sm border-0" style="background: linear-gradient(135deg, #1a237e 0%, #283593 100%);">
      <div class="card-body text-center p-4">
        <div class="d-flex align-items-center justify-content-center mb-3">
          <i class="bi bi-person-badge text-white me-3" style="font-size: 2.5rem;"></i>
          <h1 class="h3 mb-0 text-white" style="font-family: 'Poppins', sans-serif; font-weight: 600;">Employee ID Card Form</h1>
        </div>
        <p class="text-white-50 mb-0" style="font-size: 1.1rem;">District Treasury, Trivandrum</p>
      </div>
    </div>

    <div class="info-item aos-init aos-animate" data-aos="fade" data-aos-delay="300">
      <form id="employeeForm" method="post" class="php-email-form aos-init aos-animate" data-aos="fade-up" data-aos-delay="200">
        <div class="card shadow-lg border-0">
          <div class="card-header py-3" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-bottom: 3px solid #4a6bff;">
            <div class="d-flex align-items-center">
              <i class="bi bi-clipboard-data text-primary me-2" style="font-size: 1.5rem;"></i>
              <h4 class="mb-0 text-dark" style="font-family: 'Poppins', sans-serif; font-weight: 600;">Employee Details</h4>
            </div>
            <p class="mb-0 text-muted mt-1" style="font-size: 0.9rem;">Fill all fields carefully</p>
          </div>
          
          <div class="card-body p-3 p-md-4">
            <!-- Hidden Timestamp field -->
            <input type="hidden" name="timestamp" id="timestampField">
            
            <div class="row g-3">
              <!-- Treasury Section -->
              <div class="col-12">
                <div class="form-section mb-4 p-3 rounded" style="background-color: #f8f9ff; border-left: 4px solid #4a6bff;">
                  <label for="officeName" class="form-label fw-bold text-primary">
                    <i class="bi bi-building me-2"></i>Treasury Office
                  </label>
                  <select class="form-select select2" name="officeName" id="officeName" required 
                          data-placeholder="Select your treasury office" style="height: 50px;">
                    <option value="" selected disabled>Select Office</option>
                    <!-- Options will be loaded dynamically from Google Sheet -->
                  </select>
                  <div class="form-text text-muted mt-1">
                    <i class="bi bi-info-circle me-1"></i>Select your lean treasury office
                  </div>
                </div>
              </div>
              
              <!-- Personal Details Card -->
              <div class="col-12">
                <div class="card mb-4 border-0 shadow-sm">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0 text-dark" style="font-family: 'Poppins', sans-serif;">
                      <i class="bi bi-person-circle me-2 text-primary"></i>Personal Information
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-12 col-md-6">
                        <label for="employeeName" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Full Name
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-person text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0" name="employeeName" id="employeeName" 
                                 placeholder="Enter full name" required oninput="this.value = this.value.toUpperCase()">
                        </div>
                      </div>
                      
                      <div class="col-12 col-md-6">
                        <label for="pen" class="form-label fw-semibold">
                          <span class="text-danger">*</span> PEN Number
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-123 text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0" name="pen" id="pen" 
                                 placeholder="PEN Number" required oninput="this.value = this.value.toUpperCase()">
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <label for="designation" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Designation
                        </label>
                        <select class="form-select select2" name="designation" id="designation" required 
                                data-placeholder="Select your designation" style="height: 50px;">
                          <option value="" selected disabled>Select Designation</option>
                          <!-- Options will be loaded dynamically from Google Sheet -->
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Medical & Dates Card -->
              <div class="col-12">
                <div class="card mb-4 border-0 shadow-sm">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0 text-dark" style="font-family: 'Poppins', sans-serif;">
                      <i class="bi bi-calendar-heart me-2 text-primary"></i>Medical & Important Dates
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label for="bloodGroup" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Blood Group
                        </label>
                        <select class="form-select" name="bloodGroup" id="bloodGroup" required style="height: 50px;">
                          <option value="" selected disabled>Select Blood Group</option>
                          <option value="A+">A+</option>
                          <option value="A-">A-</option>
                          <option value="B+">B+</option>
                          <option value="B-">B-</option>
                          <option value="AB+">AB+</option>
                          <option value="AB-">AB-</option>
                          <option value="O+">O+</option>
                          <option value="O-">O-</option>
                        </select>
                      </div>
                      
                      <div class="col-12 col-md-4">
                        <label for="dob" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Date of Birth
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-calendar3 text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0 datepicker" name="dob" id="dob" 
                                 placeholder="DD/MM/YYYY" required style="height: 50px;">
                        </div>
                      </div>
                      
                      <div class="col-12 col-md-4">
                        <label for="retirementDate" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Retirement Date
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-calendar-check text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0 datepicker" name="retirementDate" id="retirementDate" 
                                 placeholder="DD/MM/YYYY" required style="height: 50px;">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Address Card -->
              <div class="col-12">
                <div class="card mb-4 border-0 shadow-sm">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0 text-dark" style="font-family: 'Poppins', sans-serif;">
                      <i class="bi bi-house-door me-2 text-primary"></i>Contact Address
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-12">
                        <label for="houseName" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Address Line 1 (House Name & No.)
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-house text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0" name="houseName" id="houseName" 
                                 placeholder="House name & number" required oninput="this.value = this.value.toUpperCase()">
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <label for="locality" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Address Line 2 (Locality/Area)
                        </label>
                        <input type="text" class="form-control" name="locality" id="locality" 
                               placeholder="Locality/Area details" required oninput="this.value = this.value.toUpperCase()">
                      </div>
                      
                      <div class="col-12">
                        <label for="townCity" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Address Line 3 (Town/City)
                        </label>
                        <input type="text" class="form-control" name="townCity" id="townCity" 
                               placeholder="Town/City" required oninput="this.value = this.value.toUpperCase()">
                      </div>
                      
                      <div class="col-12 col-md-6 col-lg-4">
                        <label for="pinCode" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Pin Code
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-mailbox text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0" name="pinCode" id="pinCode" 
                                 placeholder="6-digit code" required pattern="[0-9]{6}" title="6-digit pin code">
                        </div>
                      </div>
                      
                      <div class="col-12 col-md-6 col-lg-4">
                        <label for="mobileNumber" class="form-label fw-semibold">
                          <span class="text-danger">*</span> Mobile Number
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-phone text-primary"></i>
                          </span>
                          <input type="tel" class="form-control border-start-0" name="mobileNumber" id="mobileNumber" 
                                 placeholder="10-digit number" required>
                        </div>
                      </div>
                      
                      <div class="col-12 col-md-6 col-lg-4">
                        <label for="residencePhone" class="form-label fw-semibold">
                          Residence Phone
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-telephone text-primary"></i>
                          </span>
                          <input type="tel" class="form-control border-start-0" name="residencePhone" id="residencePhone" 
                                 placeholder="Optional">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Additional Information Card -->
              <div class="col-12">
                <div class="card mb-4 border-0 shadow-sm">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0 text-dark" style="font-family: 'Poppins', sans-serif;">
                      <i class="bi bi-card-checklist me-2 text-primary"></i>Additional Information
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label for="email" class="form-label fw-semibold">
                          <span class="text-danger">*</span> CRU/Email ID
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-envelope text-primary"></i>
                          </span>
                          <input type="email" class="form-control border-start-0" name="email" id="email" 
                                 placeholder="official@email.com" required>
                        </div>
                      </div>
                      
                      <div class="col-12 col-md-4">
                        <label for="idNumber" class="form-label fw-semibold">
                      Driving License/Election ID No.
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-card-text text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0" name="idNumber" id="idNumber" 
                                 placeholder="ID Number" oninput="this.value = this.value.toUpperCase()">
                        </div>
                      </div>
                      
                      <div class="col-12 col-md-4">
                        <label for="pan" class="form-label fw-semibold">
                          PAN Number
                        </label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-credit-card text-primary"></i>
                          </span>
                          <input type="text" class="form-control border-start-0" name="pan" id="pan" 
                                 placeholder="ABCDE1234F" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" 
                                 title="First 5 letters, then 4 numbers, then 1 letter" 
                                 oninput="this.value = this.value.toUpperCase()">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="col-12">
                <div class="card border-0 shadow-sm mt-4">
                  <div class="card-body p-4 text-center">
                    <!-- Color Dot Spinner hidden by default -->
                    <div id="spinner" class="dot-spinner mb-3" style="display: none;">
                      <div class="dot" style="background-color: #4a6bff;"></div>
                      <div class="dot" style="background-color: #4a6bff;"></div>
                      <div class="dot" style="background-color: #4a6bff;"></div>
                    </div>
                    
                    <div class="d-flex flex-column flex-md-row justify-content-center gap-3">
                      <!-- Submit Button -->
                      <button type="submit" id="submitBtn" class="btn btn-primary btn-lg px-4 py-3 shadow-sm" 
                              style="min-width: 200px; background: linear-gradient(135deg, #4a6bff 0%, #3a56e0 100%); border: none;">
                        <i class="bi bi-check-circle me-2"></i>Save & Review
                      </button>
                      
                      <!-- Image Upload Button -->
                      <a id="externalBtn" href="https://docs.google.com/forms/d/e/1FAIpQLSfsUCdJncZ293vXjyGH_jJc4wSbWTxVZ9yArNPhoLVgDGT1-A/viewform" 
                         target="_blank" class="btn btn-warning btn-lg px-4 py-3 shadow-sm"
                         style="min-width: 200px; background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); border: none;">
                        <i class="bi bi-camera me-2"></i>Upload Photo & Signature
                      </a>
                    </div>
                    
                    <div class="mt-3 text-muted" style="font-size: 0.85rem;">
                      <i class="bi bi-info-circle me-1"></i>Fill all details before uploading photo & signature
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #4a6bff 0%, #3a56e0 100%);">
          <h5 class="modal-title text-white" id="previewModalLabel">
            <i class="bi bi-eye me-2"></i>Review Your Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="previewContent" style="max-height: 60vh; overflow-y: auto;">
          <!-- Preview content will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
            <i class="bi bi-pencil me-1"></i>Edit Details
          </button>
          <button type="button" class="btn btn-primary px-4" id="confirmSubmit" 
                  style="background: linear-gradient(135deg, #4a6bff 0%, #3a56e0 100%); border: none;">
            <i class="bi bi-check-circle me-1"></i>Accept & Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Custom CSS for mobile optimization */
    :root {
      --primary-color: #4a6bff;
      --secondary-color: #6c757d;
      --accent-color: #ffc107;
    }
    
    * {
      font-family: 'Roboto', sans-serif;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
    }
    
    /* Form styling */
    .php-email-form {
      background: transparent;
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(74, 107, 255, 0.25);
    }
    
    .input-group-text {
      border-radius: 8px 0 0 8px;
      background-color: #f8f9fa;
    }
    
    .form-label {
      font-weight: 500;
      color: #495057;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .form-section {
      background-color: #f8f9ff;
      border-radius: 10px;
      padding: 1.25rem;
    }
    
    /* Card styling */
    .card {
      border-radius: 12px;
      border: none;
    }
    
    .card-header {
      border-radius: 12px 12px 0 0 !important;
    }
    
    /* Dot Spinner CSS */
    .dot-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary-color);
      animation: dotAnimation 1.2s infinite ease-in-out;
    }
    
    .dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes dotAnimation {
      0% {
        transform: scale(0);
      }
      50% {
        transform: scale(1);
      }
      100% {
        transform: scale(0);
      }
    }
    
    /* Button styling */
    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 107, 255, 0.3);
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }
    
    /* Preview modal styling */
    .preview-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .preview-label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    
    .preview-value {
      color: #333;
      font-size: 1rem;
      padding: 8px 12px;
      background-color: #f8f9fa;
      border-radius: 6px;
      word-break: break-word;
    }
    
    /* Select2 mobile optimization */
    .select2-container--bootstrap-5 .select2-selection {
      height: 50px !important;
      padding: 10px 15px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
      .container {
        padding-left: 12px;
        padding-right: 12px;
      }
      
      .card-body {
        padding: 1rem !important;
      }
      
      .btn-lg {
        padding: 0.75rem 1rem !important;
        font-size: 1rem;
        min-width: 100% !important;
      }
      
      .modal-dialog {
        margin: 0.5rem;
      }
      
      .modal-body {
        padding: 1rem;
      }
      
      .input-group-text {
        padding: 0.5rem;
      }
      
      .form-control, .form-select {
        font-size: 16px !important; /* Prevents iOS zoom on focus */
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h4 {
        font-size: 1.25rem;
      }
    }
    
    /* For very small screens */
    @media (max-width: 576px) {
      .row.g-3 > [class*="col-"] {
        padding-left: 8px;
        padding-right: 8px;
      }
      
      .card-header h6 {
        font-size: 0.95rem;
      }
      
      .form-label {
        font-size: 0.9rem;
      }
    }
    
    /* iOS form input fixes */
    input, select, textarea {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    /* Hide number input spinners */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    
    /* Required field asterisk */
    .text-danger {
      color: #dc3545 !important;
    }
    
    /* Progress indicator (optional) */
    .progress-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .progress-indicator::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 10%;
      right: 10%;
      height: 2px;
      background-color: #e9ecef;
      z-index: 1;
    }
    
    .step {
      position: relative;
      z-index: 2;
      text-align: center;
      flex: 1;
    }
    
    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #e9ecef;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .step.active .step-circle {
      background-color: var(--primary-color);
      color: white;
    }
    
    .step-label {
      font-size: 0.8rem;
      color: #6c757d;
    }
    
    .step.active .step-label {
      color: var(--primary-color);
      font-weight: 500;
    }
  </style>

  <script>
    // Set current timestamp when page loads
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      document.getElementById('timestampField').value = now.toISOString();
      
      // Initialize Select2 with mobile-friendly options
      $('.select2').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select option',
        allowClear: true,
        dropdownAutoWidth: true,
        width: '100%',
        dropdownParent: $('#employeeForm')
      });

      // Initialize date pickers with mobile-friendly config
      flatpickr(".datepicker", {
        dateFormat: "d/m/Y",
        allowInput: true,
        disableMobile: false,
        clickOpens: true,
        prevArrow: '<i class="bi bi-chevron-left"></i>',
        nextArrow: '<i class="bi bi-chevron-right"></i>',
        onReady: function(selectedDates, dateStr, instance) {
          if (window.innerWidth < 768) {
            instance.mobileInput.setAttribute('inputmode', 'none');
          }
        }
      });

      // Load designations and offices from Google Sheet
      loadDesignationsFromGoogleSheet();
      loadOfficesFromGoogleSheet();
      
      // Handle form submission to show preview modal first
      document.getElementById("employeeForm").addEventListener("submit", function(e) {
        e.preventDefault();
        showPreviewModal();
      });
      
      // Handle the actual form submission when user clicks Accept
      document.getElementById("confirmSubmit").addEventListener("click", function() {
        submitForm();
      });
      
      // Add touch feedback for buttons
      document.querySelectorAll('.btn').forEach(button => {
        button.addEventListener('touchstart', function() {
          this.classList.add('active');
        });
        
        button.addEventListener('touchend', function() {
          this.classList.remove('active');
        });
      });
    });

    function showPreviewModal() {
      // Create preview content
      let previewHTML = '<div class="row g-3">';
      
      // Get all form elements
      const form = document.getElementById('employeeForm');
      const elements = form.elements;
      
      // Loop through form elements and create preview items
      for (let i = 0; i < elements.length; i++) {
        const element = elements[i];
        
        // Skip buttons, hidden fields, and non-input elements
        if (element.type === 'submit' || element.type === 'button' || 
            element.type === 'hidden' || element.tagName === 'BUTTON' || 
            element.tagName === 'A') {
          continue;
        }
        
        // Get the label text
        let labelText = '';
        if (element.id) {
          const label = form.querySelector(`label[for="${element.id}"]`);
          if (label) {
            // Remove asterisk and icons from label text
            labelText = label.textContent.replace('*', '').trim();
            const icon = label.querySelector('i');
            if (icon) {
              labelText = labelText.replace(icon.textContent, '').trim();
            }
          }
        }
        
        // Get the value based on element type
        let value = '';
        if (element.type === 'select-one') {
          const selectedOption = element.options[element.selectedIndex];
          value = selectedOption.textContent;
        } else if (element.type === 'checkbox' || element.type === 'radio') {
          if (element.checked) {
            value = element.value;
          }
        } else {
          value = element.value;
        }
        
        // Skip empty values
        if (!value || value === 'Select Office' || value === 'Select Designation' || 
            value === 'Select Blood Group') {
          continue;
        }
        
        // Add to preview HTML
        previewHTML += `
          <div class="col-12 preview-item">
            <div class="preview-label">${labelText}</div>
            <div class="preview-value">${value}</div>
          </div>
        `;
      }
      
      previewHTML += '</div>';
      
      // Insert into modal
      document.getElementById('previewContent').innerHTML = previewHTML;
      
      // Show the modal
      const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
      previewModal.show();
      
      // Scroll to top of modal content
      document.getElementById('previewContent').scrollTop = 0;
    }

    function submitForm() {
      const form = document.getElementById("employeeForm");
      var submitButton = document.getElementById("submitBtn");
      var spinner = document.getElementById("spinner");
      
      // Hide the modal
      const previewModal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
      previewModal.hide();
      
      // Show spinner and hide the button
      spinner.style.display = "flex";
      submitButton.style.display = "none";
      
      // Convert date format from DD/MM/YYYY to YYYY-MM-DD for Google Sheets
      const dobInput = document.getElementById('dob');
      const retirementInput = document.getElementById('retirementDate');
      
      if (dobInput.value) {
        const dobParts = dobInput.value.split('/');
        dobInput.value = `${dobParts[2]}-${dobParts[1]}-${dobParts[0]}`;
      }
      
      if (retirementInput.value) {
        const retirementParts = retirementInput.value.split('/');
        retirementInput.value = `${retirementParts[2]}-${retirementParts[1]}-${retirementParts[0]}`;
      }
      
      var formData = new FormData(form);
      var xhr = new XMLHttpRequest();
      
      xhr.open("POST", "https://script.google.com/macros/s/AKfycbyyyvpNFnSKxRI6XYawKQ8HuBNfVeZ1QmkYqFwy7vMiPq536UGwsHaDuCLA0jc7z9iz/exec", true);
      
      xhr.onload = function() {
        // Hide spinner and show the submit button after response
        spinner.style.display = "none";
        submitButton.style.display = "inline-block";
        
        // Convert dates back to DD/MM/YYYY format
        if (dobInput.value) {
          const dobParts = dobInput.value.split('-');
          dobInput.value = `${dobParts[2]}/${dobParts[1]}/${dobParts[0]}`;
        }
        
        if (retirementInput.value) {
          const retirementParts = retirementInput.value.split('-');
          retirementInput.value = `${retirementParts[2]}/${retirementParts[1]}/${retirementParts[0]}`;
        }
        
        if (xhr.status == 200) {
          var referenceId = xhr.responseText; // Receive reference ID from the server
          
          // Show SweetAlert success message with the reference ID
          Swal.fire({
            title: 'Success!',
            html: `<div class="text-center">
                     <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                     <h4 class="mt-3">Employee ${referenceId}</h4>
                     <p class="mt-2">Details saved successfully.</p>
                     <p class="text-muted">Please update photograph and signature.</p>
                   </div>`,
            icon: 'success',
            confirmButtonText: 'OK',
            confirmButtonColor: '#4a6bff',
            customClass: {
              popup: 'rounded-3'
            }
          }).then(function() {
            form.reset(); // Reset the form after submission
            // Reset Select2
            $('.select2').val(null).trigger('change');
          });
        } else {
          // Error handling if the form submission fails
          Swal.fire({
            title: 'Error!',
            text: 'There was an issue submitting the form. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#dc3545'
          });
        }
      };
      
      xhr.send(formData);
    }

    function loadDesignationsFromGoogleSheet() {
      const spinner = document.getElementById("spinner");
      const submitButton = document.getElementById("submitBtn");
      
      // Show spinner and disable the submit button while loading
      spinner.style.display = "flex";
      submitButton.disabled = true;

      const spreadsheetId = "1srOLLRSL7CLlQgmuMUIaRh7EcDg5pfNx6Pdo8Qq2J5Q";
      const sheetName = "Options";
      const range = "D2:D";
      const apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!${range}?key=${apiKey}`;

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          const designations = [];
          if (data.values && data.values.length > 0) {
            data.values.forEach(row => {
              if (row[0]) { // Check if the cell has a value
                designations.push(row[0]);
              }
            });
          }
          
          // Remove duplicates and sort
          const uniqueDesignations = [...new Set(designations)].sort();
          
          // Populate the select element
          const select = document.getElementById('designation');
          uniqueDesignations.forEach(designation => {
            const option = document.createElement('option');
            option.value = designation;
            option.textContent = designation;
            select.appendChild(option);
          });
          
          // Refresh Select2 to show the new options
          $(select).trigger('change');
        })
        .catch(error => {
          console.error('Error loading designations:', error);
          Swal.fire({
            title: 'Error!',
            text: 'Could not load designations. Please refresh the page or contact support.',
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#dc3545'
          });
        })
        .finally(() => {
          // Hide spinner and enable the submit button
          spinner.style.display = "none";
          submitButton.disabled = false;
        });
    }

    function loadOfficesFromGoogleSheet() {
      const spinner = document.getElementById("spinner");
      const submitButton = document.getElementById("submitBtn");
      
      // Show spinner and disable the submit button while loading
      spinner.style.display = "flex";
      submitButton.disabled = true;

      const spreadsheetId = "1srOLLRSL7CLlQgmuMUIaRh7EcDg5pfNx6Pdo8Qq2J5Q";
      const sheetName = "Options";
      const range = "A2:A";
      const apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!${range}?key=${apiKey}`;

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          const offices = [];
          if (data.values && data.values.length > 0) {
            data.values.forEach(row => {
              if (row[0]) { // Check if the cell has a value
                offices.push(row[0]);
              }
            });
          }
          
          // Remove duplicates and sort
          const uniqueOffices = [...new Set(offices)].sort();
          
          // Populate the select element
          const select = document.getElementById('officeName');
          uniqueOffices.forEach(office => {
            const option = document.createElement('option');
            option.value = office;
            option.textContent = office;
            select.appendChild(option);
          });
          
          // Refresh Select2 to show the new options
          $(select).trigger('change');
        })
        .catch(error => {
          console.error('Error loading offices:', error);
          Swal.fire({
            title: 'Error!',
            text: 'Could not load offices. Please refresh the page or contact support.',
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#dc3545'
          });
        })
        .finally(() => {
          // Hide spinner and enable the submit button
          spinner.style.display = "none";
          submitButton.disabled = false;
        });
    }

    // PAN validation
    document.getElementById('pan').addEventListener('input', function(e) {
      const pan = e.target.value;
      const panPattern = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
      
      if (pan.length === 10 && !panPattern.test(pan)) {
        e.target.setCustomValidity('PAN must be in format: ABCDE1234F (5 letters, 4 numbers, 1 letter)');
        e.target.classList.add('is-invalid');
      } else {
        e.target.setCustomValidity('');
        e.target.classList.remove('is-invalid');
      }
    });
    
    // Mobile number validation
    document.getElementById('mobileNumber').addEventListener('input', function(e) {
      const mobile = e.target.value.replace(/\D/g, '');
      e.target.value = mobile;
      
      if (mobile.length === 10) {
        e.target.classList.remove('is-invalid');
      } else if (mobile.length > 0) {
        e.target.classList.add('is-invalid');
      }
    });
    
    // Pin code validation
    document.getElementById('pinCode').addEventListener('input', function(e) {
      const pin = e.target.value.replace(/\D/g, '');
      e.target.value = pin;
      
      if (pin.length === 6) {
        e.target.classList.remove('is-invalid');
      } else if (pin.length > 0) {
        e.target.classList.add('is-invalid');
      }
    });
    
    // Auto-advance to next input on mobile (optional enhancement)
    document.querySelectorAll('input, select').forEach((input, index, inputs) => {
      input.addEventListener('input', function(e) {
        if (window.innerWidth < 768 && 
            this.value.length === this.maxLength && 
            inputs[index + 1]) {
          inputs[index + 1].focus();
        }
      });
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Add jQuery and Select2 JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- Flatpickr for date picker -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</body>
</html>
